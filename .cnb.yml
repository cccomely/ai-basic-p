main:
  push:
    - env:
        SCORE: 0
    - docker:
        build: .ide/Dockerfile
      runner:
        tags: cnb:arch:amd64:gpu
      services:
        - docker
      stages:
        - name: setup
          jobs:
            - name: start-ollama
              script: |
                echo "ðŸš€ å¯åŠ¨ Ollama æœåŠ¡..."
                nohup ollama serve >/dev/null 2>&1 &
                sleep 3
                echo "âœ… Ollama æœåŠ¡å·²å¯åŠ¨"
            
            - name: verify-environment
              script: |
                echo "ðŸ” éªŒè¯çŽ¯å¢ƒé…ç½®..."
                echo "å½“å‰ Python ç‰ˆæœ¬ï¼š"
                python --version
                echo ""
                echo "å·²å®‰è£…çš„å…³é”®åŒ…ï¼š"
                pip list | grep -E "langchain|pydantic|pytest|httpx"
                echo ""
                echo "âœ… çŽ¯å¢ƒéªŒè¯å®Œæˆï¼ˆæ‰€æœ‰ä¾èµ–å·²åœ¨ Docker é•œåƒä¸­é¢„è£…ï¼‰"

        - name: test
          jobs:
            - name: run-pytest
              allowFailure: true
              script: |
                cd ai-course-labs
                echo "ðŸ§ª å¼€å§‹è¿è¡Œæµ‹è¯•..."
                echo "========================================"
                
                # è¿è¡Œ pytest å¹¶ç”Ÿæˆ JSON æŠ¥å‘Š
                pytest grader/ -v --tb=short --json-report --json-report-file=test_results.json || true
                
                echo "========================================"
                echo "ðŸ“Š ç”Ÿæˆè¯„åˆ†æŠ¥å‘Š..."
                
                # åˆ›å»ºè¯„åˆ†è®¡ç®—è„šæœ¬
                cat > calculate_score.py << 'EOF'
                import json
                import sys

                try:
                    with open('test_results.json', 'r') as f:
                        results = json.load(f)
                    
                    # èŽ·å–æµ‹è¯•ç»Ÿè®¡
                    summary = results.get('summary', {})
                    total = summary.get('total', 0)
                    passed = summary.get('passed', 0)
                    failed = summary.get('failed', 0)
                    
                    # è®¡ç®—åˆ†æ•° (æ»¡åˆ†100åˆ†)
                    if total > 0:
                        score = int((passed / total) * 100)
                    else:
                        score = 0
                    
                    # è¾“å‡ºè¯¦ç»†æŠ¥å‘Š
                    print("\n" + "="*50)
                    print("           ðŸ“‹ AIè¯¾ç¨‹å®žéªŒæµ‹è¯•æŠ¥å‘Š")
                    print("="*50)
                    print(f"æ€»æµ‹è¯•æ•°: {total}")
                    print(f"é€šè¿‡æ•°é‡: {passed} âœ…")
                    print(f"å¤±è´¥æ•°é‡: {failed} âŒ")
                    print(f"é€šè¿‡çŽ‡: {passed/total*100:.1f}%" if total > 0 else "é€šè¿‡çŽ‡: 0%")
                    print(f"\nðŸŽ¯ æœ€ç»ˆå¾—åˆ†: {score}/100")
                    print("="*50 + "\n")
                    
                    # è¾“å‡ºå„å®žéªŒè¯¦æƒ…
                    tests = results.get('tests', [])
                    lab_scores = {'lab1': [], 'lab2': [], 'lab3': [], 'lab4': []}
                    
                    for test in tests:
                        nodeid = test.get('nodeid', '')
                        outcome = test.get('outcome', '')
                        for lab in lab_scores.keys():
                            if lab in nodeid:
                                lab_scores[lab].append(outcome == 'passed')
                    
                    print("ðŸ“ å„å®žéªŒå¾—åˆ†æ˜Žç»†:")
                    for lab, results_list in lab_scores.items():
                        if results_list:
                            lab_passed = sum(results_list)
                            lab_total = len(results_list)
                            lab_score = int((lab_passed / lab_total) * 25)  # æ¯ä¸ªå®žéªŒ25åˆ†
                            print(f"  {lab.upper()}: {lab_passed}/{lab_total} é€šè¿‡ â†’ {lab_score}/25 åˆ†")
                    
                    print("\n" + "="*50)
                    
                    # è¾“å‡ºçŽ¯å¢ƒå˜é‡
                    print(f"##[set-output score={score}]")
                    
                    # é€€å‡ºç 
                    sys.exit(0 if passed == total else 1)
                    
                except Exception as e:
                    print(f"âŒ è¯„åˆ†è®¡ç®—å¤±è´¥: {e}")
                    print("##[set-output score=0]")
                    sys.exit(1)
                EOF
                
                # æ‰§è¡Œè¯„åˆ†è®¡ç®—
                python calculate_score.py
              
              exports:
                score: SCORE
        
        - name: submit-score
          jobs:
            - name: send-to-opencamp
              image: docker.cnb.cool/opencamp/learning-docker/send-score-to-opencamp:latest
              settings:
                COURSE_ID: 1914
                SCORE: $SCORE
                USER: $CNB_BUILD_USER
                CHANNEL: cnb
                TOKEN: 474da13269ca46efac13a442bfe548c5

$:
  vscode:
    - docker:
        build: .ide/Dockerfile
      runner:
        tags: cnb:arch:amd64:gpu
      services:
        - vscode
        - docker
      stages:
        - name: start ollama
          script: nohup ollama serve >/dev/null 2>&1 &